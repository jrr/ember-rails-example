version: 2
jobs:
  build:
    working_directory: ~/ember-rails-example
    docker:
      - image: circleci/ruby:2.4
      # - image: circleci/ruby:2.4-node-browsers
    steps:
      - checkout
      - run:
          name: get-chrome
          command: curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      - run:
          name: install-chrome
          command: sudo dpkg -i google-chrome.deb
      - run:
          name: get-node
          command: curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
      - run:
          name: install-node
          command: sudo apt-get install -y nodejs
      - run:
          name: bundle
          command: bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
      - run:
          name: node-version
          command: node --version
      - run:
          name: ember-deps
          command: bundle exec rake ember:install
      - run:
          name: test
          command: bundle exec rspec
      - run:
          name: test-ember
          command: bundle exec rake ember:test

    # dependencies:
    #   override:
    #     - curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    #     - sudo dpkg -i google-chrome.deb
    #     - sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
    #     - rm google-chrome.deb
    #   pre:
    #     - bundle exec rake ember:install
    #   cache_directories:
    #     - "vendor/bundle"
    #     - "frontend/bower_components"
    #     - "frontend/node_modules"
